#!/usr/bin/env ruby

require "bundler/setup"
require "logger"
require "mer"

# XXX: The fast made script to provide simple wrapper for execution from bash
# Not ready for review

mission_path = ARGV[0]

fails("Please provide path to the mission file") if mission_path.nil?

logger = Logger.new(STDERR)

plateau = nil
rover = nil
mission = nil

# Perform mission in a lazy way (one by one),
# because number of rovers could be huge :)

File.foreach(mission_path) do |line|
  line = line.chomp

  unless plateau
    # performed only once for the first line in the file
    plateau = Mer::Plateau.parse(line)
    next
  end

  unless rover
    rover = Mer::Rover.parse(line)
    next
  end

  mission = Mer::Mission.parse(line)

  engine = Mer::Engine.new(
    plateau: plateau,
    rover: rover,
    mission: mission,
    logger: logger
  )
  engine.run
  puts("#{rover.x} #{rover.y} #{rover.orientation_label}")

  # reset rover
  rover = nil
end
